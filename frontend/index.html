<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VesselTracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* --- UI THEME --- */
    :root {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --danger: #ef4444;
      --text-main: #111827;
      --text-soft: #6b7280;
      --radius-lg: 12px;
      --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.08);
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, Arial, sans-serif;
      padding: 24px;
      margin: 0;
      background: radial-gradient(circle at top left, #e0f2fe, #f9fafb 45%, #eef2ff);
      color: var(--text-main);
    }
    h1, h2 { margin: 0 0 8px; }
    h1 { font-size: 1.6rem; font-weight: 600; }
    h2 { font-size: 1.2rem; color: var(--text-soft); font-weight: 500; }
    .layout { max-width: 960px; margin: 0 auto; }
    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 16px 18px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }
    .row { display: flex; gap: 8px; margin-bottom: 8px; }
    input[type="text"] {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      font-size: 0.9rem;
    }
    button {
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.85rem;
      text-transform: uppercase;
      font-weight: 500;
      cursor: pointer;
    }
    button.primary { background: var(--accent); color: #fff; }
    button.danger { background: var(--danger); color: #fff; }
    .vessels { display: flex; flex-direction: column; gap: 10px; }
    .vessel-card {
      padding: 10px 12px;
      border-radius: 10px;
      background: #fff;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }
    .meta-line { font-size: 0.78rem; color: var(--text-soft); }
    .tag-row { display: flex; gap: 6px; flex-wrap: wrap; }
    .tag { background: #f3f4f6; padding: 3px 6px; border-radius: 6px; font-size: 0.75rem; }
    .tag.distance { background: var(--accent-soft); color: #1d4ed8; }
  </style>
</head>
<body>
<div class="layout">

  <h1>VesselTracker</h1>
  <h2>GitHub + API + WhatsApp alerts</h2>

  <!-- ADD IMO -->
  <div class="card">
    <div class="row">
      <input id="imoInput" type="text" placeholder="Enter IMO (e.g. 6417499)">
      <button class="primary" onclick="addIMO()">Add</button>
    </div>
    <div id="namePreview" style="font-size:0.9rem; color:#6b7280;"></div>
    <div id="status" style="font-size:0.8rem; color:#6b7280;"></div>
  </div>

  <!-- LIST -->
  <div class="card">
    <div style="margin-bottom:10px; font-weight:600;">Tracked Vessels</div>
    <div id="vesselsContainer" class="vessels"></div>
  </div>

</div>

<script>
/* ===========================
   CONFIG – CHANGE THESE
=========================== */
const USERNAME = "asmahri2-afk";
const REPO = "VesselTracker";
const BRANCH = "main";

/* Put your GitHub PAT here */
const GITHUB_TOKEN = "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";

/* Your Render API for instant vessel name lookup */
const RENDER_API = "https://vessel-api-s85s.onrender.com";

/* Paths */
const TRACKED_PATH = "data/tracked_imos.json";
const VESSELS_PATH = "data/vessels_data.json";

/* Elements */
const statusEl = document.getElementById("status");
const namePreviewEl = document.getElementById("namePreview");
const vesselsContainer = document.getElementById("vesselsContainer");
const imoInput = document.getElementById("imoInput");


/* ===========================
   1. LIVE NAME LOOKUP
=========================== */
imoInput.addEventListener("input", async () => {
  const imo = imoInput.value.trim();
  if (!imo) {
    namePreviewEl.textContent = "";
    return;
  }

  namePreviewEl.textContent = "Checking…";

  try {
    const url = `https://vessel-api-s85s.onrender.com/vessel-full/${imo}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error("API error");

    const data = await res.json();

    // ✅ use data.name (matches main.py)
    if (data.name) {
      namePreviewEl.textContent = `${data.name} | IMO ${imo}`;
    } else {
      namePreviewEl.textContent = `Name not found | IMO ${imo}`;
    }

  } catch (err) {
    console.error(err);
    namePreviewEl.textContent = `Name not found | IMO ${imo}`;
  }
});




/* ===========================
   2. GITHUB API HELPERS
=========================== */
async function ghGet(path, fallback) {
  const url = `https://api.github.com/repos/${USERNAME}/${REPO}/contents/${path}?ref=${BRANCH}`;
  const headers = { "Accept": "application/vnd.github+json" };
  if (GITHUB_TOKEN) headers["Authorization"] = `Bearer ${GITHUB_TOKEN}`;

  const res = await fetch(url, { headers });
  if (!res.ok) {
    if (res.status === 404) return { data: fallback, sha: null };
    throw new Error("GitHub GET error " + res.status);
  }

  const json = await res.json();
  const raw = atob(json.content.replace(/\n/g, ""));
  return { data: JSON.parse(raw), sha: json.sha };
}

async function ghPut(path, data, sha, msg) {
  const url = `https://api.github.com/repos/${USERNAME}/${REPO}/contents/${path}`;
  const headers = {
    "Accept": "application/vnd.github+json",
    "Content-Type": "application/json"
  };
  if (GITHUB_TOKEN) headers["Authorization"] = `Bearer ${GITHUB_TOKEN}`;

  const body = {
    message: msg,
    content: btoa(JSON.stringify(data, null, 2)),
    branch: BRANCH
  };
  if (sha) body.sha = sha;

  const res = await fetch(url, {
    method: "PUT",
    headers,
    body: JSON.stringify(body)
  });

  if (!res.ok) throw new Error("GitHub PUT error " + res.status);
}


/* ===========================
   3. ADD IMO
=========================== */
async function addIMO() {
  const imo = imoInput.value.trim();
  if (!imo) return;

  statusEl.textContent = "Adding IMO…";

  try {
    const { data, sha } = await ghGet(TRACKED_PATH, []);
    let list = Array.isArray(data) ? data : data.tracked_imos || [];
    list = list.map(String);

    if (!list.includes(imo)) list.push(imo);
    list.sort();

    await ghPut(TRACKED_PATH, list, sha, `Add IMO ${imo}`);

    statusEl.textContent = "Added.";
    imoInput.value = "";
    namePreviewEl.textContent = "";

    loadData();
  } catch (err) {
    statusEl.textContent = "Error: " + err.message;
  }
}


/* ===========================
   4. REMOVE IMO
=========================== */
async function removeIMO(imo) {
  statusEl.textContent = "Removing…";

  try {
    const { data, sha } = await ghGet(TRACKED_PATH, []);
    let list = Array.isArray(data) ? data : data.tracked_imos || [];

    list = list.filter(x => x !== String(imo));

    await ghPut(TRACKED_PATH, list, sha, `Remove IMO ${imo}`);

    statusEl.textContent = "Removed.";
    loadData();
  } catch (err) {
    statusEl.textContent = "Error: " + err.message;
  }
}


/* ===========================
   5. LOAD ALL DATA
=========================== */
async function loadData() {
  vesselsContainer.textContent = "Loading…";

  const trackedInfo = await ghGet(TRACKED_PATH, []);
  const vesselsInfo = await ghGet(VESSELS_PATH, {});

  const tracked = Array.isArray(trackedInfo.data)
    ? trackedInfo.data
    : trackedInfo.data.tracked_imos || [];

  let vessels;
  if (Array.isArray(vesselsInfo.data)) vessels = vesselsInfo.data;
  else if (Array.isArray(vesselsInfo.data.vessels)) vessels = vesselsInfo.data.vessels;
  else vessels = Object.values(vesselsInfo.data);

  renderVessels(tracked, vessels);
}


/* ===========================
   6. RENDER VESSELS
=========================== */
function renderVessels(tracked, vessels) {
  vesselsContainer.innerHTML = "";

  tracked.forEach(imo => {
    const v = vessels.find(x => String(x.imo) === String(imo)) || {};

    const card = document.createElement("div");
    card.className = "vessel-card";

    card.innerHTML = `
      <div style="font-weight:600; font-size:0.95rem;">${v.name || "Name not found"}</div>
      <div class="meta-line">IMO ${imo}</div>
      <div class="meta-line"><strong>AIS UTC:</strong> ${v.last_pos_utc || "N/A"}</div>
      <div class="meta-line"><strong>Pos:</strong> ${
        v.lat && v.lon ? `${v.lat.toFixed(4)}, ${v.lon.toFixed(4)}` : "N/A"
      }</div>

      <div class="meta-line"><strong>Destination:</strong> ${v.destination || "N/A"}</div>

      <div class="tag-row">
        ${v.sog ? `<span class="tag">SOG ${v.sog.toFixed(1)} kn</span>` : ""}
        ${v.cog ? `<span class="tag">COG ${v.cog.toFixed(0)}°</span>` : ""}
        ${v.nearest_port && v.nearest_distance_nm ?
          `<span class="tag distance">${v.nearest_port}: ${v.nearest_distance_nm.toFixed(1)} NM</span>` : ""}
        ${v.destination_port && v.destination_distance_nm ?
          `<span class="tag distance">To dest: ${v.destination_distance_nm.toFixed(1)} NM</span>` : ""}
      </div>

      <button class="danger" onclick="removeIMO('${imo}')" style="margin-top:6px;">BIN</button>
    `;

    vesselsContainer.appendChild(card);
  });
}

loadData();
</script>

</body>
</html>
